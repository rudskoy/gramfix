name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Triggers on tags like v1.0, v1.1, v2.0

env:
  SCHEME: Gramfix
  PROJECT: Gramfix.xcodeproj

permissions:
  contents: write  # Required for creating releases and uploading assets

jobs:
  build:
    name: Build and Sign
    runs-on: macos-26  # macOS Tahoe with Xcode 26 (Liquid Glass support)
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      dmg_name: ${{ steps.version.outputs.DMG_NAME }}
      signature: ${{ steps.sign.outputs.SIGNATURE }}
      size: ${{ steps.sign.outputs.SIZE }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: List available Xcode versions
        run: |
          echo "Available Xcode versions:"
          ls -la /Applications/ | grep Xcode
          echo ""
          echo "Current Xcode:"
          xcode-select -p
      
      - name: Select Xcode 26
        run: |
          # macOS 26 has Xcode 26.0 as default, but let's be explicit
          if [ -d "/Applications/Xcode_26.0.app" ]; then
            sudo xcode-select -s /Applications/Xcode_26.0.app/Contents/Developer
          elif [ -d "/Applications/Xcode.app" ]; then
            sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          fi
      
      - name: Show Xcode version
        run: |
          xcodebuild -version
          echo ""
          echo "SDK versions:"
          xcodebuild -showsdks | head -20
      
      - name: Resolve Swift packages
        run: |
          xcodebuild -resolvePackageDependencies \
            -project $PROJECT \
            -scheme $SCHEME
      
      - name: Update version and copyright from git tag
        run: |
          VERSION="${GITHUB_REF_NAME#v}"  # Remove 'v' prefix: v1.2 -> 1.2
          YEAR=$(date +%Y)  # Get current year
          
          echo "Updating MARKETING_VERSION to $VERSION in project.pbxproj"
          echo "Updating copyright year to $YEAR in project.pbxproj"
          
          # Update MARKETING_VERSION in all build configurations
          sed -i '' "s/MARKETING_VERSION = [0-9.]*/MARKETING_VERSION = ${VERSION}/g" "$PROJECT/project.pbxproj"
          
          # Update copyright year in all build configurations
          sed -i '' "s/Copyright © [0-9]*/Copyright © ${YEAR}/g" "$PROJECT/project.pbxproj"
          
          # Verify the changes
          echo "Updated versions:"
          grep "MARKETING_VERSION = " "$PROJECT/project.pbxproj" | head -4
          echo ""
          echo "Updated copyright:"
          grep "INFOPLIST_KEY_NSHumanReadableCopyright" "$PROJECT/project.pbxproj" | head -2
      
      - name: Build Release
        run: |
          xcodebuild -project $PROJECT \
            -scheme $SCHEME \
            -configuration Release \
            -derivedDataPath build/DerivedData \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            build 2>&1 | tee build.log
          
          # Check for build success
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "Build failed. Last 100 lines of log:"
            tail -100 build.log
            exit 1
          fi
      
      - name: Verify app bundle
        run: |
          APP_PATH="build/DerivedData/Build/Products/Release/Gramfix.app"
          if [ ! -d "$APP_PATH" ]; then
            echo "Error: App bundle not found at $APP_PATH"
            echo "Contents of build directory:"
            find build -name "*.app" 2>/dev/null || echo "No .app found"
            exit 1
          fi
          echo "App bundle found at $APP_PATH"
          ls -la "$APP_PATH"
      
      - name: Create DMG
        id: version
        run: |
          APP_PATH="build/DerivedData/Build/Products/Release/Gramfix.app"
          VERSION="${GITHUB_REF_NAME#v}"  # Remove 'v' prefix: v1.0 -> 1.0
          DMG_NAME="Gramfix-${VERSION}.dmg"
          
          # Create staging directory
          mkdir -p dmg_staging
          cp -R "$APP_PATH" dmg_staging/
          
          # Add Applications symlink for drag-install
          ln -s /Applications dmg_staging/Applications
          
          # Create DMG
          hdiutil create \
            -volname "Gramfix $VERSION" \
            -srcfolder dmg_staging \
            -ov \
            -format UDZO \
            "$DMG_NAME"
          
          echo "DMG_NAME=$DMG_NAME" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Download Sparkle tools
        run: |
          SPARKLE_VERSION="2.6.4"
          curl -L -o sparkle.tar.xz \
            "https://github.com/sparkle-project/Sparkle/releases/download/${SPARKLE_VERSION}/Sparkle-${SPARKLE_VERSION}.tar.xz"
          mkdir -p sparkle
          tar -xf sparkle.tar.xz -C sparkle
      
      - name: Sign DMG with Sparkle
        id: sign
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          DMG_NAME="${{ steps.version.outputs.DMG_NAME }}"
          
          # Write private key to temp file (will be deleted after)
          echo "$SPARKLE_PRIVATE_KEY" > /tmp/sparkle_key
          
          # Sign the DMG and extract signature
          SIGN_OUTPUT=$(./sparkle/bin/sign_update "$DMG_NAME" --ed-key-file /tmp/sparkle_key)
          SIGNATURE=$(echo "$SIGN_OUTPUT" | grep -o 'sparkle:edSignature="[^"]*"' | sed 's/sparkle:edSignature="\([^"]*\)"/\1/')
          
          # Clean up private key immediately
          rm -f /tmp/sparkle_key
          
          # Get file size
          SIZE=$(stat -f%z "$DMG_NAME")
          
          echo "SIGNATURE=$SIGNATURE" >> $GITHUB_OUTPUT
          echo "SIZE=$SIZE" >> $GITHUB_OUTPUT
          
          echo "DMG signed successfully"
          echo "   Size: $SIZE bytes"
      
      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: gramfix-dmg
          path: ${{ steps.version.outputs.DMG_NAME }}
          retention-days: 7

  # ==========================================================================
  # Manual Approval Gate: Publish to rudskoy/gramfix
  # ==========================================================================
  # This job requires manual approval via the "production" environment.
  # Set up the environment in: Settings > Environments > New environment > "production"
  # Enable "Required reviewers" and add yourself.
  # ==========================================================================
  
  publish-to-releases:
    name: Publish to rudskoy/gramfix
    needs: build
    runs-on: ubuntu-latest
    environment: production  # Requires manual approval
    
    steps:
      - name: Download DMG artifact
        uses: actions/download-artifact@v4
        with:
          name: gramfix-dmg
      
      - name: Create Release on rudskoy/gramfix
        env:
          GH_TOKEN: ${{ secrets.RELEASES_PAT }}
          VERSION: ${{ needs.build.outputs.version }}
          DMG_NAME: ${{ needs.build.outputs.dmg_name }}
          SIGNATURE: ${{ needs.build.outputs.signature }}
          SIZE: ${{ needs.build.outputs.size }}
        run: |
          gh release create "v${VERSION}" \
            --repo rudskoy/gramfix \
            --title "Gramfix v${VERSION}" \
            --notes "## Gramfix v${VERSION}
          
          ### Download
          - **[Gramfix-${VERSION}.dmg](https://github.com/rudskoy/gramfix/releases/download/v${VERSION}/Gramfix-${VERSION}.dmg)**
          
          ### Installation
          1. Download the DMG
          2. Open it and drag Gramfix to Applications
          3. Right-click Gramfix → Open (first time only, to bypass Gatekeeper)
          
          ---
          
          ### For appcast.xml (copy this):
          \`\`\`xml
          <item>
            <title>Version ${VERSION}</title>
            <sparkle:version>${VERSION}</sparkle:version>
            <sparkle:shortVersionString>${VERSION}</sparkle:shortVersionString>
            <sparkle:minimumSystemVersion>15.0</sparkle:minimumSystemVersion>
            <enclosure 
              url=\"https://github.com/rudskoy/gramfix/releases/download/v${VERSION}/Gramfix-${VERSION}.dmg\"
              sparkle:edSignature=\"${SIGNATURE}\"
              length=\"${SIZE}\"
              type=\"application/octet-stream\"/>
          </item>
          \`\`\`" \
            "${DMG_NAME}"
          
          echo "Release created: https://github.com/rudskoy/gramfix/releases/tag/v${VERSION}"
